<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR釣竿</title>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; }
        video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
        
        /* アプリ名 */
        #app-title {
            position: absolute; top: 15px; left: 15px;
            font-size: 16px; font-weight: bold; color: rgba(255,255,255,0.8);
            background: rgba(0,0,0,0.4); padding: 5px 10px; border-radius: 15px;
            pointer-events: none;
            z-index: 10;
        }

        /* 十字線 */
        #crosshair {
            position: absolute; top: 50%; left: 50%;
            width: 40px; height: 40px;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            transition: border-color 0.2s;
            z-index: 5;
        }
        #crosshair::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 4px; height: 4px; background: red;
            transform: translate(-50%, -50%); border-radius: 50%;
        }

        /* 判定結果 (IN/OUT) */
        #judgement {
            position: absolute; top: 30%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem; font-weight: 900;
            text-shadow: 0px 0px 10px rgba(0,0,0,0.8);
            display: none;
            z-index: 5;
        }
        .status-in { color: #00ff00; }
        .status-out { color: #ff0000; }

        /* 左下：情報ボックス */
        #info-box {
            position: absolute; bottom: 80px; left: 10px;
            font-size: 14px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px;
            text-shadow: 1px 1px 1px #000; pointer-events: none;
            z-index: 5;
            transition: bottom 0.3s ease;
        }
        .val { font-weight: bold; color: #ffeb3b; }
        .label { font-size: 11px; color: #ccc; }

        /* 右上：カウンター */
        #counter-box {
            position: absolute; top: 15px; right: 15px;
            background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px;
            text-align: center; pointer-events: auto; min-width: 70px;
            z-index: 20;
        }
        #count-val { font-size: 36px; font-weight: bold; color: #00ff00; }
        #btn-count { background: #28a745; color: white; width: 100%; margin-top: 5px; padding: 12px; font-weight: bold; border-radius: 5px; border: none; font-size: 18px;}
        
        /* 設定パネル (開閉式) */
        #controls {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.9);
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            display: flex; flex-direction: column;
            z-index: 30;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform: translateY(0);
        }
        
        #controls.collapsed {
            transform: translateY(calc(100% - 50px)); 
        }

        #ctrl-header {
            height: 50px;
            display: flex; justify-content: center; align-items: center;
            background: rgba(255,255,255,0.1);
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            cursor: pointer;
            color: #007bff; font-weight: bold;
        }
        #toggle-icon { margin-left: 10px; font-size: 12px; }

        #ctrl-content {
            padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            padding-bottom: 40px; 
        }

        .row { display: flex; justify-content: space-between; align-items: center; }
        
        /* 入力フォーム共通スタイル */
        select, input[type="number"] { 
            width: 100px; padding: 8px; font-size: 16px; 
            border-radius: 5px; border: none; background: #fff; color: #000; 
            text-align: right; 
        }

        button { padding: 12px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; }
        .btn-set { background: #ff9800; color: black; font-weight: bold; width: 100%; }
        .btn-start { background: #007bff; color: white; width: 100%; font-weight: bold; }
        
        .check-row { justify-content: flex-end; font-size: 12px; color: #ccc; margin-top: -5px;}
        input[type="checkbox"] { transform: scale(1.5); margin-right: 5px; }
        
        /* 現在方位表示 */
        #live-azimuth { font-size: 12px; color: #00ff00; margin-left: 10px; font-weight: bold; }

    </style>
</head>
<body>

    <video id="video" autoplay playsinline muted></video>

    <div id="app-title">AR釣竿 v1.2</div>

    <div id="ui-layer">
        <div id="crosshair"></div>
        <div id="judgement">STANDBY</div>
    </div>

    <div id="info-box">
        <span class="label">現在の地面勾配</span><br>
        <span id="disp-slope" class="val">0.0</span>° <span id="disp-slope-dir"></span><br>
        <span class="label">補正後半径(斜距離)</span><br>
        <span id="disp-radius" class="val">5.60</span>m<br>
        <span class="label" style="font-size:10px;">(設定水平半径: <span id="disp-base-radius">5.6</span>m)</span>
    </div>

    <div id="counter-box">
        <div style="font-size:12px;">本数</div>
        <div id="count-val">0</div>
        <button id="btn-count" onclick="incrementCount()">＋</button>
        <button onclick="resetCount()" style="font-size:11px; background:#555; color:#ccc; margin-top:8px; padding:5px; width:100%; border:none; border-radius:4px;">クリア</button>
    </div>

    <div id="controls">
        <div id="ctrl-header" onclick="toggleControls()">
            設定 <span id="toggle-icon">▼</span>
        </div>

        <div id="ctrl-content">
            <button class="btn-start" onclick="requestPermissions()">1. 測定スタート (センサーON)</button>
             <div style="font-size: 10px; text-align: center; color: #aaa; margin-bottom: 10px;">※最初に押してください</div>

            <div class="row">
                <label>釣竿の長さ(m)</label>
                <input type="number" id="plotRadiusInput" value="5.6" step="0.01">
            </div>

            <div class="row">
                <label>目の高さ(cm)</label>
                <select id="eyeHeight">
                    </select>
            </div>
            <div class="row">
                <label>山の傾斜(度)</label>
                <select id="slopeAngle">
                    </select>
            </div>
            
            <div class="row check-row">
                <label><input type="checkbox" id="reverseSlope">山谷判定を逆にする</label>
            </div>
    
            <div class="row">
                <button class="btn-set" onclick="setSlopeDirection()">2. 現在の方位を「山側」にセット</button>
            </div>
            
            <div style="text-align:center; color:#aaa; font-size:12px;">
                現在の方位: <span id="live-azimuth">---</span> / セット済: <span id="set-azimuth">未設定</span>
            </div>
            
        </div>
    </div>

<script>
    // --- 初期化 ---
    window.onload = function() {
        // 目の高さ
        const eyeSel = document.getElementById('eyeHeight');
        for(let h=120; h<=200; h+=5){
            const opt = document.createElement('option');
            opt.value = h;
            opt.text = h + " cm";
            if(h === 160) opt.selected = true;
            eyeSel.appendChild(opt);
        }

        // 山の傾斜
        const slopeSel = document.getElementById('slopeAngle');
        for(let s=0; s<=50; s+=5){
            const opt = document.createElement('option');
            opt.value = s;
            opt.text = s + " 度";
            if(s === 25) opt.selected = true;
            slopeSel.appendChild(opt);
        }
    };

    // --- UI操作 ---
    function toggleControls() {
        const panel = document.getElementById('controls');
        const icon = document.getElementById('toggle-icon');
        const infoBox = document.getElementById('info-box');

        panel.classList.toggle('collapsed');

        if(panel.classList.contains('collapsed')) {
            icon.innerText = "▲";
            infoBox.style.bottom = "60px"; 
        } else {
            icon.innerText = "▼";
            infoBox.style.bottom = "420px"; // パネルが大きくなったので調整
        }
    }

    // --- 変数 ---
    let currentPlotRadiusH = 5.6; 
    let eyeHeightM = 1.6;
    let maxSlopeDeg = 25;
    let slopeAzimuth = null;
    let currentAzimuth = 0;  
    let currentTilt = 0;     
    let isReverseSlope = false;
    let count = 0;
    
    // 安全装置用フラグ
    let isSensorActive = false;

    // --- 計算ロジック ---
    function calculate() {
        // 入力値の取得
        currentPlotRadiusH = parseFloat(document.getElementById('plotRadiusInput').value);
        eyeHeightM = parseInt(document.getElementById('eyeHeight').value) / 100;
        maxSlopeDeg = parseInt(document.getElementById('slopeAngle').value);
        isReverseSlope = document.getElementById('reverseSlope').checked;
        
        if(!currentPlotRadiusH || currentPlotRadiusH <= 0) currentPlotRadiusH = 5.6;

        let effectiveSlopeDeg = 0;
        
        if (slopeAzimuth !== null) {
            let diff = currentAzimuth - slopeAzimuth;
            let diffRad = diff * (Math.PI / 180);
            let factor = Math.cos(diffRad);
            
            if(isReverseSlope) factor = -factor;
            effectiveSlopeDeg = maxSlopeDeg * factor;
        }

        const effSlopeRad = effectiveSlopeDeg * (Math.PI / 180);
        const groundRise = currentPlotRadiusH * Math.tan(effSlopeRad);
        const targetY = groundRise - eyeHeightM;
        const limitRad = Math.atan(targetY / currentPlotRadiusH);
        const limitDeg = limitRad * (180 / Math.PI);

        const slopeDistance = Math.sqrt(Math.pow(currentPlotRadiusH, 2) + Math.pow(groundRise, 2));

        // 表示更新
        const dispSlope = document.getElementById('disp-slope');
        const dispDir = document.getElementById('disp-slope-dir');
        
        dispSlope.innerText = Math.abs(effectiveSlopeDeg).toFixed(1);
        if(effectiveSlopeDeg > 0.1) {
            dispSlope.style.color = "#ffeb3b"; 
            dispDir.innerText = "(上り)";
        } else if (effectiveSlopeDeg < -0.1) {
            dispSlope.style.color = "#00ffff"; 
            dispDir.innerText = "(下り)";
        } else {
            dispSlope.style.color = "#fff";
            dispDir.innerText = "(平坦)";
        }

        document.getElementById('disp-radius').innerText = slopeDistance.toFixed(2);
        document.getElementById('disp-base-radius').innerText = currentPlotRadiusH;

        // 判定
        const judgeElem = document.getElementById('judgement');
        const crosshair = document.getElementById('crosshair');

        if (currentTilt < limitDeg) {
            judgeElem.style.display = 'block';
            judgeElem.innerText = 'IN';
            judgeElem.className = 'status-in';
            crosshair.style.borderColor = '#00ff00';
        } else {
            judgeElem.style.display = 'block';
            judgeElem.innerText = 'OUT';
            judgeElem.className = 'status-out';
            crosshair.style.borderColor = '#ff0000';
        }
    }

    // --- センサー処理 ---
    function handleOrientation(event) {
        // センサーが動いていることを記録
        isSensorActive = true;

        if (event.webkitCompassHeading) {
            currentAzimuth = event.webkitCompassHeading;
        } else if (event.alpha) {
            currentAzimuth = event.alpha; 
        }
        currentTilt = event.beta - 90;
        
        // 設定パネル内に現在の方位を表示（動いているか確認用）
        document.getElementById('live-azimuth').innerText = Math.round(currentAzimuth) + "°";

        calculate();
    }

    // 方位セット時の安全装置
    function setSlopeDirection() {
        if (!isSensorActive) {
            alert("⚠️ センサーが動いていません。\n先に「1. 測定スタート」ボタンを押して、カメラと方位センサーを許可してください。");
            return;
        }

        slopeAzimuth = currentAzimuth;
        document.getElementById('set-azimuth').innerText = Math.round(slopeAzimuth) + "°";
        alert("✅ 山側の方位をセットしました！\nパネルを閉じて測定してください。");
        
        // 自動で閉じる
        toggleControls();
    }

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            document.getElementById('video').srcObject = stream;
        } catch (err) {
            console.error(err);
        }
    }

    function requestPermissions() {
        // スタートボタンを押したときは、パネルを閉じない（すぐセットしたい場合があるため）
        // または、カメラが見たいので閉じても良いが、今回は「セット」へ誘導するため開いたままにするか、
        // ユーザーにお任せします。一旦ここでは閉じないように変更します。
        
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(state => {
                    if (state === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                        // スタートボタンの色を変えて「稼働中」感す
                        document.querySelector('.btn-start').style.background = "#28a745";
                        document.querySelector('.btn-start').innerText = "センサー稼働中";
                    } else {
                        alert("センサー許可が必要です");
                    }
                });
        } else {
            window.addEventListener('deviceorientation', handleOrientation);
            isSensorActive = true; 
        }
        startCamera();
    }

    function incrementCount() {
        count++;
        document.getElementById('count-val').innerText = count;
    }
    function resetCount() {
        if(confirm("リセットしますか？")) {
            count = 0;
            document.getElementById('count-val').innerText = count;
        }
    }
</script>
</body>
</html>
